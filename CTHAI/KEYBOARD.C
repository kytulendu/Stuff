#include <stdlib.h>
#include <dos.h>
#include <bios.h>
#include <ctype.h>

#include "keyboard.h"

#define RIGHT  0x01
#define LEFT   0x02
#define CTRL   0x04
#define ALT    0x08

typedef unsigned char       BYTE;
typedef unsigned int        WORD;

#define LOWORD(l)           ((WORD)(l))
#define HIWORD(l)           ((WORD)(((DWORD)(l) >> 16) & 0xFFFF))
#define LOBYTE(w)           ((BYTE)(w))
#define HIBYTE(w)           ((BYTE)(((WORD)(w) >> 8) & 0xFF))

unsigned char _thai_kb[0x54] = {
    0x00, 0x1B, 0x00, 0x2F, 0x5F, 0xC0, 0xB6, 0xD8, 0xD6, 0xA4, 0xB5, 0xA8, 0xA2, 0xAA, 0x08, 0x09,
    0xE6, 0xE4, 0xD3, 0xBE, 0xD0, 0xD1, 0xD5, 0xC3, 0xB9, 0xC2, 0xBA, 0xC5, 0x0D, 0x00, 0xBF, 0xCB,
    0xA1, 0xB4, 0xE0, 0xE9, 0xE8, 0xD2, 0xCA, 0xC7, 0xA7, 0x00, 0x00, 0x60, 0xBC, 0xBB, 0xE1, 0xCD,
    0xD4, 0xD7, 0xB7, 0xC1, 0xE3, 0xBD, 0x00, 0x2A, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x37, 0x38, 0x39, 0x2D, 0x34, 0x35, 0x36, 0x2B, 0x31,
    0x32, 0x33, 0x30, 0x2E };

unsigned char _thai_kbs[0x54] = {
    0x00, 0x1B, 0x00, 0xF1, 0xF2, 0xF3, 0xF4, 0xD9, 0xDB, 0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0x08, 0x09,
    0xF0, 0x22, 0xAE, 0xB1, 0xB8, 0xEB, 0xEA, 0xB3, 0xCF, 0xAD, 0xB0, 0x2C, 0x0D, 0x00, 0xC4, 0xA6,
    0xAF, 0xE2, 0xAC, 0xE7, 0xEB, 0xC9, 0xC8, 0xAB, 0x2E, 0x00, 0x00, 0x7E, 0x28, 0x29, 0xA9, 0xCE,
    0x25, 0xEC, 0x3F, 0xB2, 0xCC, 0x3F, 0x00, 0x2A, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF7, 0xF8, 0xF9, 0x2D, 0xF4, 0xF5, 0xF6, 0x2B, 0xF1,
    0xF2, 0xF3, 0xF0, 0x2E };

int _thai_key = 1, _last_key = 0, _eng_only_key = 0, _num_only_key = 0;
#define KEY_BUFF_SIZE 20
int head_key = 0, tail_key = 0, key_buff[KEY_BUFF_SIZE];

void Write_KB( int key )
{
    if ( ( head_key + 1 ) % KEY_BUFF_SIZE != tail_key )
    {
        key_buff[head_key] = key;
        head_key = ( head_key + 1 ) % KEY_BUFF_SIZE;
    }
}

int KB_Hit( )
{
    if ( head_key != tail_key ) return 1;
    return !( _bios_keybrd( _KEYBRD_READY ) == 0 );
}

int Get_KB( ) {
    int key, modifiers;

    if ( head_key != tail_key )
    {
        key = key_buff[tail_key];
        tail_key = ( tail_key + 1 ) % KEY_BUFF_SIZE;
        _last_key = key;
        return key;
    }
    key = _bios_keybrd( _KEYBRD_READ );
    if ( ( HIBYTE( key ) == 0x29 ) && ( !_eng_only_key ) && ( !_num_only_key ) )
    {
        _thai_key = !_thai_key;
        return 0;
    }

    if ( LOBYTE( key ) != 0 )
    {
        if ( _num_only_key )
        {
            if ( isdigit( LOBYTE( key ) ) || ( LOBYTE( key ) == KEY_BACKSPACE ) ||
                ( LOBYTE( key ) == KEY_ENTER ) || ( LOBYTE( key ) == KEY_ESC ) )
                return ( _last_key = LOBYTE( key ) );
            else return 0;
        }
        if ( _thai_key && ( LOBYTE( key )>32 ) && ( !_eng_only_key ) )
        {
            modifiers = _bios_keybrd( _KEYBRD_SHIFTSTATUS );
            if ( ( modifiers & RIGHT ) || ( modifiers & LEFT ) )
            {
                if ( _thai_kbs[HIBYTE( key )] == 0xDB )
                {
                    Write_KB( 0xE9 );
                    return ( _last_key = 0xD1 );
                }
                return ( _last_key = _thai_kbs[HIBYTE( key )] );
            }
            return ( _last_key = _thai_kb[HIBYTE( key )] );
        }
        else
            return ( _last_key = LOBYTE( key ) );
    }
    return ( _last_key = key );
}

int Get_LastKey( )
{
    return _last_key;
}

int Get_ThaiKey( )
{
    return _thai_key;
}

void Set_ThaiKey( int i )
{
    _thai_key = i;
}

int Get_EngOnlyKey( )
{
    return _eng_only_key;
}

void Set_EngOnlyKey( int i )
{
    _eng_only_key = i;
}

int Get_NumOnlyKey( )
{
    return _num_only_key;
}

void Set_NumOnlyKey( int i )
{
    _num_only_key = i;
}

void Show_Cursor( int x, int y )
{
    static char t_and_mask[] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF,
        0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF,
        0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF };
    static char t_xor_mask[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00,
        0x81, 0x00, 0x81, 0x00, 0xC7, 0x00, 0xC7, 0x00,
        0xC7, 0x00, 0xC7, 0x00, 0xC7, 0x00, 0xFF, 0x00 };
    static char e_and_mask[] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF,
        0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF,
        0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF };
    static char e_xor_mask[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00,
        0x81, 0x00, 0x81, 0x00, 0x8F, 0x00, 0x83, 0x00,
        0x8F, 0x00, 0x81, 0x00, 0x81, 0x00, 0xFF, 0x00 };
    static char n_and_mask[] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF,
        0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF,
        0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF };
    static char n_xor_mask[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00,
        0x99, 0x00, 0x89, 0x00, 0x81, 0x00, 0x81, 0x00,
        0x81, 0x00, 0x91, 0x00, 0x99, 0x00, 0xFF, 0x00 };
    int     show = 1;
    long    tm, otm;

    otm = biostime( 0, 0L );
    if ( _num_only_key )
        Set_Cursor( n_and_mask, n_xor_mask, 0, 15 );
    else if ( _thai_key && !_eng_only_key )
        Set_Cursor( t_and_mask, t_xor_mask, 0, 15 );
    else Set_Cursor( e_and_mask, e_xor_mask, 0, 15 );
    Move_Cursor( x, y );
    while ( !KB_Hit( ) )
    {
        tm = biostime( 0, 0L );
        if ( !show && ( tm - otm ) >= 5 )
        {
            show = 1;
            otm = tm;
            Move_Cursor( x, y );
        }
        if ( show && ( tm - otm ) >= 5 )
        {
            show = 0;
            otm = tm;
            Remove_Cursor( );
        }
    }
    if ( show ) Remove_Cursor( );
}

void Beep( ) {
    long tm;
    sound( 2000 );
    tm = biostime( 0, 0L );
    tm += 1;
    while ( biostime( 0, 0L ) <= tm );
    nosound( );
}

int Alt2Chr( int key ) {
    static int chkey[] = { 'Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P', 0, 0, 0, 0,
        'A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 0, 0, 0, 0, 0,
        'Z', 'X', 'C', 'V', 'B', 'N', 'M' };
    if ( ( key<KEY_ALT_Q ) || ( key>KEY_ALT_M ) ) return 0;
    return chkey[HIBYTE( key - KEY_ALT_Q )];
}

